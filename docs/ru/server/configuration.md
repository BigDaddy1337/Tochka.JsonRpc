# Сервер/Конфигурация

Есть два способа настроить поведение библиотеки: лямбда с настройками в `Program.cs` и атрибуты для контроллеров/методов/параметров.

*Также можно заменить сервисы для обработки запросов или унаследоваться от них, но здесь такой способ не описан.*

> Смотрите страницу [Примеры](examples), чтобы узнать, как настройки влияют на запросы/ответы

## Program.cs options

`.AddJsonRpcServer()` поддерживает перегрузку с возможностью настроить `JsonRpcServerOptions`.

```cs
builder.Services.AddJsonRpcServer(static options =>
{
    options.AllowRawResponses = true;
    options.RoutePrefix = "/api/test";
});
```

### AllowRawResponses

> Значение по умолчанию: `false`

> Если `true`, то сервер может возвращать ответы, нарушающие протокол JSON-RPC, например, HTTP статус коды, бинарные данные и тп.

Методы/фильтры ASP.Net Core возвращают `IActionResult` с HTTP кодом, контент и тд.
Мы пытаемся конвертировать их к ответу, который всегда `200 OK` и сериализовать контент к JSON-RPC ответу.
Однако такой подход ломает некоторые вполне валидные сценарии.

Например, если у вас используется аутентификация, `AuthenticationFilter` откинет запрос без нужных куки и вернет `ChallengeResult`, который сериализуется как HTTP редирект. Это сломает протокол JSON-RPC, но несомненно полезно. Если вы хотите, чтоб аутентификация **просто работала**, выставьте `AllowRawResponses = true`.

Другой кейс: вы можете захотеть возвращать HTTP ответ с произвольным не-JSON контентом. Это естественно нарушает протокол, но, например, может избавить от лишней сериализации больших файлов.

На данный момент, распознаются и кастуются к JSON-RPC ответу следующие `IActionResult`:

* `ObjectResult`: метод возвращает обычный ответ
* `StatusCodeResult`: например, когда вы возвращаете `NotFound()`
* `EmptyResult`: метод имеет тип возвращаемого значения `void`

Для всех остальных результатов:

* В случае `false`, сервер отвечает JSON-RPC ошибкой сервера
* В случае `true`, позволяет фреймворку обработать его как ответ обычного REST контроллера.

**Замечание:** Батчи **ломаются** если данная настройка включена и один из ответов содержит не-JSON данные! Смотрите [Батчи](batches).

### DetailedResponseExceptions

> Значение по умолчанию: `false`

> Если `true`, исключения сериализуются вместе с их `.ToString()`, который включает стек трейс

Исключения, вызванные данной библиотекой, мидлварями или пользовательским кодом, отлавливаются и сериализуются как JSON-RPC ошибка с объектом `ExceptionInfo`.

`ExceptionInfo` всегда содержит сообщение и тип исключения.
Если данная настройка `true`, то оно также будет содержать `.ToString()` исключения со всеми подробностями.

Мы не рекомендуем включать данную функцию на продакшене. 

### DefaultMethodStyle

> Значение по умолчанию: `JsonRpcMethodStyle.ControllerAndAction`

> Управление тем, как JSON-RPC поле `method` связывается с контроллерами/методами

* `ControllerAndAction`: интерпретировать `method` как `controller.action`. Значение `foo.bar` будет привязано к `FooController.Bar`
* `ActionOnly`: интерпретировать `method` как `action`. Значение `bar` будет привязано к методу `Bar` в любом контроллере

Сериализация имен реализуется через `DataJsonSerializerOptions`, подробности смотрите ниже и на странице [Сериализация](serialization).

Данное значение может быть переопределено с помощью `JsonRpcMethodStyleAttribute` или проигнорировано, если имя метода задано вручную с помощью `JsonRpcMethodAttribute`

### DefaultDataJsonSerializerOptions

> Значение по умолчанию: `JsonRpcSerializerOptions.SnakeCase`

> `JsonSerializerOptions` для сериализации полей `params` и `method`, а также десериализации полей `result` и `error.data`

**Контент** сериализуется отдельно от "заголовков" JSON-RPC объекта.
Для типичных случаев в пакете `Tochka.JsonRpc.Common` определены `JsonRpcSerializerOptions.SnakeCase` и `JsonRpcSerializerOptions.CamelCase`.

Примеры использования можно посмотреть на странице [Сериализация](serialization).

Данное значение может быть переопределено с помощью `JsonRpcSerializerOptionsAttribute`, если использовать реализацию интерфейса `IJsonSerializerOptionsProvider`, зарегистрированную в DI.

### HeadersJsonSerializerOptions

> Значение по умолчанию: `JsonRpcSerializerOptions.Headers`

> `JsonSerializerOptions` для сериализации/десериализации JSON-RPC "заголовков": `id`, `jsonrpc`, и тд.

Не рекомендуется изменять данное значение, так как объект "заголовков" запроса/ответа имеет фиксированный формат и не подразумевает каких-либо изменений.

### RoutePrefix

> Значение по умолчанию: `JsonRpcConstants.DefaultRoutePrefix` равное `"/api/jsonrpc"`

> Стандартный префикс пути для всех контроллеров/методов, унаследованных от `JsonRpcControllerBase`

Все обработчики JSON-RPC должны иметь одинаковый префикс адреса, чтобы отличать их от REST запросов, если оба API используются в одном проекте. Если префикс не указан явно в адресе обработчика, то он будет добавлен автоматически. Для обработчиков, у которых адрес не указан вручную, префикс будет использоваться как полный адрес (без части `/controllerName`).

Путь может быть переопределен с помощью стандартного `RouteAttribute` из фреймворка, и глобальный префикс будет добавлен в его начало, если данный путь еще не содержит его.

* Должен начинаться с `/`
* Может быть установлено значение `"/"`, чтобы избавиться от него

## Атрибуты

### JsonRpcSerializerOptionsAttribute

> Переопределение `DefaultDataJsonSerializerOptions` для контроллера/метода. Детали про `IJsonSerializerOptionsProvider` описаны выше и на странице [Сериализация](serialization).

### JsonRpcMethodStyleAttribute

> Переопределение `DefaultMethodStyle` для контроллера/метода. Детали про `DefaultMethodStyle` описаны выше.

### JsonRpcMethodAttribute

> Определение значения поля `method` вручную для любого метода, игнорирует `DefaultMethodStyle` и `JsonRpcMethodStyleAttribute`. Детали про `DefaultMethodStyle` описаны выше.

### FromParamsAttribute

> Переопределение способа привязки моделей к параметрам по умолчанию (`BindingStyle.Default`)

Изменение того, как JSON-RPC поле `params` привязывается к аргументам метода. Смотрите [Привязка моделей](binding).
