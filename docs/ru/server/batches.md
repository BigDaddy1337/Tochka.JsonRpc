# Сервер/Батчи

Батчи обрабатываются в `JsonRpcMiddleware` за счет отчистки эндпоинта и данных JSON-RPC в `HttpContext` для каждого элемента в батче. `HttpContext` не потокобезопасный, в связи с чем на данный момент поддерживается только последовательная обработка. Единственной альтернативой является копирование объекта `HttpContext` перед обработкой каждого элемента, однако такой способ создает дубли данных при схлопывании этих копий в один контекст ответа, а также является сложным в реализации, в связи с чем параллельная обработка пока что не поддерживается.

Для определения, является ли текущий вызов частью батча, можно использовать метод расширения для `HttpContext` - `JsonRpcRequestIsBatch()`
Он может быть полезен, если вы хотите проставлять какой-то заголовок только один раз или написать особую логику в мидлварях или фильтрах.

Если включено `AllowRawResponses` и один из вызовов вернет сырые данные,
батч запрос будет содержать их среди остальных JSON результатов, что **сломает** всю структуру JSON ответа. На данный момент хорошего решения этой проблемы не найдено, однако вероятно можно добавить дополнительные проверки против подобной ситуации.

Еще одно замечание: для элементов батча не создается отдельного скоупа, в связи с чем все сервисы зарегистрированные как `Scoped` будут одинаковыми в рамках одного батча.
Это может быть и хорошо и плохо, в зависимости от сценария.